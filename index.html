<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VS Alex - æœ€çµ‚æ¥ç¶šãƒ†ã‚¹ãƒˆ</title>

    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; }
        #alex-box { background: #2a2a2a; width: 85%; max-width: 500px; margin: 0 auto; padding: 30px; border-radius: 20px; border: 2px solid #444; }
        #alex-text { font-size: 1.4rem; font-weight: bold; min-height: 60px; margin-bottom: 10px; }
        #translation { color: #888; font-size: 1rem; margin-bottom: 30px; }
        .mic-btn { width: 90px; height: 90px; border-radius: 50%; border: none; background: #e53935; color: white; font-size: 2.2rem; cursor: pointer; }
        .mic-btn.listening { background: #43a047; box-shadow: 0 0 20px #43a047; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="alex-box">
        <div id="alex-text">Testing Connection...</div>
        <div id="translation">æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...</div>
        <button id="mic-btn" class="mic-btn">ğŸ¤</button>
        <div id="status" style="margin-top:20px; color:#666;">ä»Šåº¦ã¯ãƒ¢ãƒ‡ãƒ«åã‚’æœ€æ–°ç‰ˆã«ä¿®æ­£ã—ãŸã</div>
    </div>

    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- (A) AIã®åˆæœŸè¨­å®š ---
        const API_KEY = "AIzaSyBsb4sW9ox5UCFmxRDZDn-A9sjBTvZ1w_I";
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // ã€é‡è¦ä¿®æ­£ã€‘ãƒ¢ãƒ‡ãƒ«åã‚’ "gemini-1.5-flash" ã‹ã‚‰ "gemini-1.5-flash-latest" ã«å¤‰æ›´
        // ã“ã‚Œã§ 404 ã‚¨ãƒ©ãƒ¼ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„ï¼‰ã‚’å›é¿ã™ã‚‹ã€‚
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

        const micBtn = document.getElementById('mic-btn');
        const alexText = document.getElementById('alex-text');
        const translationDiv = document.getElementById('translation');
        const statusDiv = document.getElementById('status');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';

        micBtn.onclick = () => {
            recognition.start();
            micBtn.classList.add('listening');
            statusDiv.innerText = "Listening...";
        }

        recognition.onresult = async (event) => {
            micBtn.classList.remove('listening');
            const userText = event.results[0][0].transcript;
            statusDiv.innerText = "You said: " + userText;
            alexText.innerText = "Thinking...";

            try {
                // AIã«é€ã‚‹å‘½ä»¤ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
                const prompt = `ã‚ãªãŸã¯è¶…å³ã—ã„ä¸Šå¸ã®Alexã§ã™ã€‚éƒ¨ä¸‹ã®è‹±èªãŒä¸‹æ‰‹ã ã¨æ€’ã‚Šã¾ã™ã€‚çŸ­ãè‹±èªã§1æ–‡ã§è¿”ç­”ã—ã€æœ€å¾Œã«ã€Œæ—¥æœ¬èªè¨³ï¼šã€œã€œã€ã¨ã¤ã‘ã¦ã€‚: ${userText}`;
                
                // é€šä¿¡é–‹å§‹
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();

                // è‹±èªã¨æ—¥æœ¬èªã«åˆ†ã‘ã‚‹
                const parts = text.split('æ—¥æœ¬èªè¨³ï¼š');
                const english = parts[0].trim();
                const japanese = parts[1] ? parts[1].trim() : "";

                alexText.innerText = english;
                translationDiv.innerText = japanese;

                // å–‹ã‚‰ã›ã‚‹
                const uttr = new SpeechSynthesisUtterance(english);
                uttr.lang = 'en-US';
                window.speechSynthesis.speak(uttr);

            } catch (e) {
                console.error(e);
                // ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã€ãã®å†…å®¹ã‚’ç”»é¢ã«ã‚‚å‡ºã™ã‚ˆã†ã«ã—ãŸ
                alexText.innerText = "Error...";
                translationDiv.innerText = "ã‚¨ãƒ©ãƒ¼è©³ç´°: " + e.message;
            }
        };
    </script>
</body>
</html>
