<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VS Alex - è‹±èªç‰¹è¨“</title>

    <style>
        /* ç”»é¢å…¨ä½“ã®èƒŒæ™¯ã¨æ–‡å­—ã®è‰² */
        body { 
            background: #1a1a1a; 
            color: white; 
            font-family: 'Helvetica', sans-serif; 
            text-align: center; 
            padding-top: 50px; 
        }

        /* Alexã¨ã®ä¼šè©±ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³ã®ç®±ï¼ˆæ ï¼‰ */
        #alex-box { 
            background: #2a2a2a; 
            width: 85%; 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 30px; 
            border-radius: 20px; 
            border: 2px solid #444; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }

        /* AlexãŒå–‹ã£ãŸè‹±èªã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ */
        #alex-text { 
            font-size: 1.4rem; 
            font-weight: bold; 
            min-height: 60px; 
            margin-bottom: 10px; 
        }

        /* æ—¥æœ¬èªè¨³ã‚’è¡¨ç¤ºã™ã‚‹å°‘ã—è–„ã„è‰²ã®å ´æ‰€ */
        #translation { 
            color: #888; 
            font-size: 1rem; 
            margin-bottom: 30px; 
        }

        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .mic-btn { 
            width: 90px; height: 90px; 
            border-radius: 50%; 
            border: none; 
            background: #e53935; 
            color: white; 
            font-size: 2.2rem; 
            cursor: pointer; 
            transition: 0.3s; 
        }

        /* éŒ²éŸ³ä¸­ï¼ˆlisteningçŠ¶æ…‹ï¼‰ã®æ™‚ã«ãƒœã‚¿ãƒ³ã‚’ç·‘ã«ã—ã¦å…‰ã‚‰ã›ã‚‹è¨­å®š */
        .mic-btn.listening { 
            background: #43a047; 
            box-shadow: 0 0 20px #43a047; 
            animation: pulse 1s infinite; 
        }

        /* ãƒœã‚¿ãƒ³ãŒãƒãƒ¯ãƒ³ãƒãƒ¯ãƒ³ã¨å‹•ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        }
    </style>
</head>
<body>

    <div id="alex-box">
        <div id="alex-text">Ready for you.</div>
        <div id="translation">æº–å‚™ã¯ã„ã„ã‹ã€‚</div>
        
        <button id="mic-btn" class="mic-btn">ğŸ¤</button>
        
        <div id="status" style="margin-top:20px; color:#666;">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è‹±èªã§è©±ã›</div>
    </div>

    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- (A) AIã®åˆæœŸè¨­å®š ---
        const API_KEY = "AIzaSyBsb4sW9ox5UCFmxRDZDn-A9sjBTvZ1w_I";
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // ã“ã“ã‚’ã€Œgemini-1.5-flash-latestã€ã«å¤‰æ›´ï¼
        // ã“ã‚ŒãŒæœ€æ–°ã®ã€Œã©ã“ã‹ã‚‰ã§ã‚‚ç¹‹ãŒã‚‹ã€æ­£å¼ãªåå‰ã ã€‚
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

        // --- (B) å„ãƒ‘ãƒ¼ãƒ„ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã„ã˜ã‚Œã‚‹ã‚ˆã†ã«åå‰ã‚’ã¤ã‘ã‚‹ ---
        const micBtn = document.getElementById('mic-btn');
        const alexText = document.getElementById('alex-text');
        const translationDiv = document.getElementById('translation');
        const statusDiv = document.getElementById('status');

        // --- (C) éŸ³å£°èªè­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è€³ï¼‰ã®æº–å‚™ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US'; // è‹±èªã‚’èãå–ã‚‹ã‚ˆã†ã«è¨­å®š

        // --- (D) ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‹•ã ---
        micBtn.onclick = () => {
            recognition.start(); // èãå–ã‚Šé–‹å§‹
            micBtn.classList.add('listening'); // è¦‹ãŸç›®ã‚’ç·‘ã«ã—ã¦å…‰ã‚‰ã›ã‚‹
            statusDiv.innerText = "Listening...";
        }

        // --- (E) è‹±èªã‚’è©±ã—çµ‚ã‚ã£ãŸç¬é–“ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç† ---
        recognition.onresult = async (event) => {
            micBtn.classList.remove('listening'); // ãƒœã‚¿ãƒ³ã®è‰²ã‚’æˆ»ã™
            const userText = event.results[0][0].transcript; // ä»Šå›ãŒå–‹ã£ãŸè‹±èªã‚’æ–‡å­—ã«ã™ã‚‹
            statusDiv.innerText = "You said: " + userText;
            alexText.innerText = "Thinking...";

            try {
                // ã€AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‘
                // ã“ã“ã§ã€ŒAlexã€ã®æ€§æ ¼ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå‘½ä»¤æ–‡ï¼‰ã§æŒ‡å®šã—ã¦ã„ã‚‹
                const prompt = `ã‚ãªãŸã¯è¶…å³ã—ã„ä¸Šå¸ã®Alexã§ã™ã€‚éƒ¨ä¸‹ã®è‹±èªãŒä¸‹æ‰‹ã ã¨æ€’ã‚Šã¾ã™ã€‚çŸ­ãè‹±èªã§1æ–‡ã§è¿”ç­”ã—ã€æœ€å¾Œã«ã€Œæ—¥æœ¬èªè¨³ï¼šã€œã€œã€ã¨ã¤ã‘ã¦ã€‚: ${userText}`;
                
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();

                // ã€è¿”ã£ã¦ããŸè¿”ç­”ã‚’åˆ†å‰²ã€‘
                // ã€Œæ—¥æœ¬èªè¨³ï¼šã€ã¨ã„ã†æ–‡å­—ã‚’å¢ƒç›®ã«ã€è‹±èªã¨æ—¥æœ¬èªã«åˆ†ã‘ã‚‹
                const parts = text.split('æ—¥æœ¬èªè¨³ï¼š');
                const english = parts[0].trim();
                const japanese = parts[1] ? parts[1].trim() : "";

                // ç”»é¢ã«è¡¨ç¤º
                alexText.innerText = english;
                translationDiv.innerText = japanese;

                // ã€å£°ã‚’å‡ºã™ã€‘
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®èª­ã¿ä¸Šã’æ©Ÿèƒ½ï¼ˆéŸ³å£°åˆæˆï¼‰ã‚’ä½¿ã£ã¦è‹±èªã‚’å–‹ã‚‰ã›ã‚‹
                const uttr = new SpeechSynthesisUtterance(english);
                uttr.lang = 'en-US';
                window.speechSynthesis.speak(uttr);

            } catch (e) {
                // ä½•ã‹ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã“ã“ã«é£›ã‚“ã§ãã‚‹
                console.error(e);
                alexText.innerText = "Error...";
                translationDiv.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‹ã€ã‚­ãƒ¼ã®å•é¡Œã ã€‚";
            }
        };
    </script>
</body>
</html>
